# Generated by Django 4.2.6 on 2023-10-24 20:22
import random
from typing import cast

from django.db import (
    migrations,
    transaction,
)
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps

from book_catalogue import models as book_catalogue_models


# noinspection PyPep8Naming
def create_data(apps: StateApps, _schema_editor: BaseDatabaseSchemaEditor) -> None:
    Author = cast(type[book_catalogue_models.Author], apps.get_model("book_catalogue", "Author"))
    Publisher = cast(type[book_catalogue_models.Publisher], apps.get_model("book_catalogue", "Publisher"))
    Genre = cast(type[book_catalogue_models.Genre], apps.get_model("book_catalogue", "Genre"))
    Book = cast(type[book_catalogue_models.Book], apps.get_model("book_catalogue", "Book"))

    with transaction.atomic():
        authors = [
            Author(first_name="Author", last_name="One", date_of_birth="2023-01-01"),
            Author(first_name="Author", last_name="Two", date_of_birth="2023-01-01"),
            Author(first_name="Author", last_name="Three", date_of_birth="2023-01-01"),
        ]
        Author.objects.bulk_create(authors)

        publishers = [
            Publisher(name="Publisher One", address="Address One"),
            Publisher(name="Publisher Two", address="Address Two"),
            Publisher(name="Publisher Three", address="Address Three"),
            Publisher(name="Publisher Four", address="Address Four"),
        ]
        Publisher.objects.bulk_create(publishers)

        genres = [Genre(name=f"Genre #{i}") for i in range(1, 26)]
        Genre.objects.bulk_create(genres)

        books = [
            Book(
                title=f"Book #{i}",
                summary=f"Summary for Book #{i}",
                author=authors[i % 3],
                publisher=publishers[i % 4],
                publish_date="2023-01-01",
            )
            for i in range(1, 61)
        ]
        Book.objects.bulk_create(books)

        for book in books:
            for genre_idx in random.sample(range(len(genres)), k=random.randint(1, 7)):
                book.genres.add(genres[genre_idx])


class Migration(migrations.Migration):
    dependencies = [
        ("book_catalogue", "0001_initial"),
    ]

    operations = [migrations.RunPython(create_data, migrations.RunPython.noop)]
